# Database Migrations

## Migration: Convert Integer IDs to Text (cuid2)

### Problem
The database schema still has integer/serial ID columns, but the application code expects text (cuid2) IDs. This causes errors like:
```
invalid input syntax for type integer: "bod0bk80v9yj0inbio13vuud"
```

### Solution
Run the migration script `001_convert_ids_to_text.sql` to convert all integer ID columns to text.

### How to Run

#### Option 1: Using the Bash Script (Recommended)
```bash
export DATABASE_URL='postgresql://user:password@host:port/database'
./migrations/run-migration.sh
```

#### Option 2: Using npm script
```bash
export DATABASE_URL='postgresql://user:password@host:port/database'
npm run migrate:ids-to-text
```

#### Option 3: Using psql directly
```bash
psql $DATABASE_URL -f migrations/001_convert_ids_to_text.sql
```

#### Option 4: Manual Execution
1. Connect to your PostgreSQL database
2. Copy and paste the SQL from `001_convert_ids_to_text.sql`
3. Execute it

### Important Notes

⚠️ **BACKUP YOUR DATABASE FIRST** - This migration modifies column types and cannot be easily reversed.

- This migration converts all integer/serial IDs to text
- Foreign key constraints should automatically update
- Existing integer IDs will be converted to text (e.g., `1` becomes `"1"`)
- New records will use cuid2 strings generated by the application
- If you have existing integer IDs that need to be preserved, you may need to:
  1. Create a mapping table
  2. Generate new cuid2 IDs for existing records
  3. Update foreign key references
  4. Then run this migration

### Verification

After running the migration, verify the changes:

```sql
-- Check data_source table
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'data_source' AND column_name LIKE '%id%';

-- Should show:
-- id: text
-- chatbot_id: text
```

### Troubleshooting

If you encounter foreign key constraint errors:

1. Temporarily disable foreign key checks:
```sql
SET session_replication_role = 'replica';
```

2. Run the migration

3. Re-enable foreign key checks:
```sql
SET session_replication_role = 'origin';
```

Or drop and recreate constraints manually for problematic tables.

